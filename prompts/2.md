I'll gather the current testExtraction.py content and the upstream langextract documentation to ground the prompt design. I'll inspect `schema.py` to understand existing extraction schema capabilities for designing the new prompt. I'll read `data.py` for extraction object definitions to ensure alignment with prompt output keys. I'll examine `prompting.py` to see recommended patterns for prompt descriptions and constraints. Kicking off by framing what we need: to evolve your current prompt (focused on door evacuation norms) into a mission‑critical regulatory ontology and norm extraction engine for Spain’s multi-level building law corpus—capturing hierarchy, applicability logic, location zoning, questionnaire generation, annex/form consequences, and a disciplined DSL.

## Plan (initial checklist)
1. Clarify objectives & scope expansion (entities, outputs, lifecycle).
2. Clarify ontology & tagging strategy (hierarchy, naming, governance).
3. Clarify DSL specification (operators, data types, location model, tag paths).
4. Clarify extraction schema (what extraction classes, required/optional fields).
5. Clarify location & zoning handling (granularity, formats, ambiguity resolution).
6. Clarify questionnaire generation requirements (when, structure, constraints).
7. Clarify annex/form & consequence modeling.
8. Clarify operational constraints (accuracy vs recall, chunking, multi-doc links).
9. Draft output JSON schema options (narrow vs rich) for you to choose.
10. After answers: deliver `/extraction_prompt.md` with full instructions + rationale.

Below are the targeted clarification questions. Once you answer (even partially), I’ll produce the finalized prompt file and, if useful, update testExtraction.py to load it.

---

## 1. Scope & Objectives
1.1 Do you want a single extraction pass to produce BOTH atomic norms and ontology/tag hierarchy suggestions, or separate modes (e.g., mode: taxonomy vs mode: norms)?  ANSWER: For now single run.
1.2 Should the model propose new tags on the fly when no suitable existing tag exists, or must it only reuse from a fixed seed list you’ll provide?  ANSWER: We will start with almost none, it should generate them, but it must always check wether a new topic matches something it generated earlier. Also it must continuesly reaccess the hierarchical order (e.g. if it discovers a new topic that would be mid-chain, they need to be considered for adaption)
1.3 Is the extraction language always Spanish source → English DSL field names (as you already started) or should DSL keys remain English while quoted literals remain Spanish?  ANSWER: Source documents are in spanish and catalan
1.4 Should we preserve original text spans verbatim including line breaks/typos (e.g., hyphen splits) or normalize whitespace?   ANSWER: NO, but we need to capture the chunk, the source, where the source is from, where in the source it can be found, and, if applicable, any visual references (tables, images, maps)

## 2. Ontology & Tag Hierarchy
2.1 Preferred delimiter remains dot (`FURNITURE.TABLE.LEG`)—confirm?  ANSWER: YES
2.2 Do you want both:
- canonical tag path (`house.gate.door.automatic`) and
- a short slug (`door.automatic`) or a UUID?   ANSWER: NO, ALL CANONICAL
2.3 How do you want to handle synonyms (e.g., “puerta giratoria”, “torno”)? Keep `synonyms` array per tag?  ANSWER: Ideally match, but yes, probably its clever to record synonyms.
2.4 Should hierarchical parents be auto-inferred (splitting path) or only from explicit textual cues?  auto inteferred by semantic and area of regulation
2.5 Maximum desired depth? (Unlimited, or e.g., <=5 levels?)   ANSWER: as long as there is still more than a few in the final node, infinite, the goal is only to not create a flat long list of 1000+ entries.

## 3. Norm Semantics
3.1 Besides `applies_if`, `exempt_if`, `satisfied_if`, do you also need:
- `violated_if` (explicit contradiction/negative case)  ANSWER: probably YES
- `partially_satisfied_if` (multi-condition norms)
Or is `satisfied_if` + logical composition enough?  ANSWER: I assume if applies=true and satisfies=false then its violated or not specified, correct? If this is the case, it's enough
3.2 Do you need a field for obligation type (`MANDATORY`, `PROHIBITION`, `PERMISSION`, `CONDITIONAL`) inferred from verbs? ANSWER: YES
3.3 Should we extract numeric parameters separately (structured list of thresholds) for easier downstream normalization?  ANSWER: YES

## 4. Project & Actor Dimensions
4.1 Enumerate project dimensions you already know (e.g., `project.type IN { 'new_build','reform','expansion','demolition' }`)?  PROJECT.TYPE=[NEW, REFORM, AMPLIACION_ESTRUCTURA, LEGALISATION] OWNERSHIP=[PRIVATE, COMMERICAL, EDUCATION, PUBLIC, ...] USAGE=[FAMILY.SINGLE, FAMILY.MULTIPLE, PUBLIC.EDUCATION, PUBLIC.GOV, PUBLIC.PARK, HOSPITAL, AGRICULTURE ...] WORK.TYPE=[NEW_BUILD, DEMOLITION.PARTIAL, DEMOLITION.TOTAL, USAGE.CHANGE.WHOLE, USAGE.CHANGE.PARTIAL, CONSTRUCTION.INSIDE, CONSTRUCTION.OUTSIDE, CONSTRUCTION.STRUCTURAL, CONSTRUCTION.FLOORS, CONSTRUCTION.DOORS, CONSTRUCTION.WINDOWS, CONSTRUCTION.STAIRS, CONSTRUCTION.EMERGENCYPATH, ELECTRO.ELEVATOR, ELECTRO.HEATING, ELECTRO.CLIMATE, ELECTRO.PHOTOVOLTAIC, ELECTRO.PHOTOVOLTAIC.INTERIOR, ELECTRO.PHOTOVOLTAIC.EXTERIOR, ELECTRO.PHOTOVOLTAIC.EXTERIOR.GARDEN,  ELECTRO.RADIOCOMMUNICATION, ELECTRO.OTHER, GAS.HEATING, GAS.KITCHEN, GAS.OTHER] WORK.EFFECTS=[CLOSURE.STREET, CLOSURE.PARK, CLOSURE.AREA, CONSTRUCTION.FACILITIES] WORK.TYPE.AUXILARY=[CONSTRUCTION, SWIMMINGPOOL, ELECTRO.RADIOCOMMUNICATION ...]
4.2 Actor relevance: distinguish professional roles? (architect, constructor, owner, authority) → Should we add `relevant_for_roles` array?
4.3 Are some norms only relevant during a lifecycle phase (design, execution, maintenance)? Add `lifecycle_phase`?
+4.4: GENERAL TOPICS WORTH MAPPING: TOPICS=[SAFETY.STRUCTURAL, SAFETY.FIRE, SAFETY.USE, ACCESSIBILITY, SAFETY.ACCIDENTPREVENTION, HEALTH, SANITATION, PROTECTION.DAMP. PROTECTION.INDOOR.AIR, PROTECTION.ELECTRONICS, PROTECTION.SUPPLY.WATER, PROTECTION.NOISE, ENERGYSAVING, ENERGYSAVING.THERMAL, ENERGYSAVINGS.SOLAR, ENERGYSAVINGS.PV, ENERGYSAVINGS.HVAC.EFFICIENCY, ENERGYSAVINGS.LIGHTING.EFFICIENCY] MATERIALSANDEFFECTS=[LOADS, SNOW, WIND, EARTHQUAKES, RAIN, FOUNDATIONS, STEEL, MASONRY, TIMBER, ALUMINIUM ...]

## 5. Location & Zoning
5.1 Canonical hierarchy: confirm structure: `country > state(autonomous_community) > province? > region? > commune > planning_zone_code`. Spain also has provinces—do you need that layer?  ANSWER: YES + We need to record any layer/instance that in itself is able to define things for its area/zone. So if its mentioned, yes.
5.2 Should model extract any code-like tokens (regex e.g. `[A-Z]?\d+(\.\d+)?` or mixtures like `R6.2`, `PEM2`) under a `planning_zones` array? ANSWER:  WE SHOULD CAPTURE ALL REAL ENTTITIES (E.G: COUNTY, STATE, PROVINCE ...) and then have a ZONES LIST [P9.1, XXX2, ...]
5.3 Should we attempt to classify zone codes (e.g., residential vs industrial) or just capture raw code + surrounding snippet?  ANSWER: YES, definetely. Ideally even relationship to conneting or in other way relevant zones, streets, things.
5.4 If a norm states multiple geographic scopes, do we produce multiple norms or a single norm with OR logic in `applies_if`?  ANSWER MULTIPLE IF SOURCE ALSO DIFFERENT (E.G: A norm of Spain will apply to everyone, but a catalan norm only to catalans => need to record both)

## 6. Questionnaire Generation
6.1 Trigger rule: generate questionnaire items ONLY for high-level tags (non-leaf) that appear in at least N norms? What’s N (default maybe 3)?  ANSWER: ASSES BY CONTEXT. IF TOPIC FEELS BIG, UNSPECIFIC, WIDE, CONNECTED TO ALOT OF OTHER TOPICS -> CAPTURE QUESTIONNAIRE
6.2 Desired questionnaire item fields: `question_id`, `tag_path`, `question_text`, `expected_answer_type (BOOLEAN|ENUM|NUMBER|STRING)`, `enumeration_values`, `derived_dsl_key`?  YES
6.3 Should questions map 1:1 to a single DSL variable (like `door.type`) or can one question feed multiple variables? If multiple, do we need `outputs` array?  YES, MULTIPLE
6.4 Any style constraints on question wording (imperative vs interrogative Spanish vs neutral)?  ANSWER: FOLLOW SOURCE

## 7. Annexes / Forms / Consequences
7.1 Required to detect if a norm mandates attaching a form or annex—fields like `requires_annex: true`, `annex_reference: 'Anexo III'`, `annex_type`?  ANSWER YES, ALSO IF IT MANDATES THAT NOW MORE/DIFFERENT/OTHER RULES APPLY + WHICH
7.2 Other consequence types? (e.g., certification, inspection, penalty triggers). Provide categories?   DECLARATIONS, STATEMENTS, CERTIFICATIONS, INSPECTIONS, SURVEYS, TRIGGERS, QUESTIONNAIRES (as defined in 6, they can be a consequence), NORMS, TAGS
7.2.1 ALSO QUESTIONNAIRES AND TAGS can have CONSEQUENCES (dynamic rule system)
7.3 Should these consequences become separate extraction objects or attributes of the same Norm?  YES

## 8. DSL Specification Details
8.1 Case sensitivity: Are field names lowercase snake/dot-case only?  UPPERCASE.DOTCASE
8.2 Enum literals single-quoted (already doing) — allow spaces? (`'residential vivienda'`?) or prefer underscores?  IN['ENUM_VALUE_ONE','ENUM_VALUE_TWO', ...]
8.3 Add `IN [...]` vs your current `IN { ... }`: keep curly braces?  brackets
8.4 Should we support numeric ranges shorthand like `x IN [0,20]` or enforce `x >= 0 AND x <= 20`?  ENFORCE
8.5 Need geo scoping operators? e.g., `location.within('ES.CT.BCN')` or simple equality chain?  ANSWER YES, GEO SCOPING OPERATORS
8.6 Allow tag existence tests: `has(tag.path)` or express via boolean field e.g. `tag.house.gate == true`?  YES

## 9. Output Schema & Classes
Propose extraction classes (choose which you want):
- `Norm`
- `Tag` (taxonomy element)
- `Question` (questionnaire item)
- `Consequence` (if separated)
+ LOCATIONENTITIES
Options:

Option A (single list): All objects in one `extractions` array with `type` discriminator.
Option B (segregated): Top-level keys: `norms`, `tags`, `questions`, `consequences`.
Which is preferable for downstream ingestion? ANSWER: B

## 10. Quality / Conflict Handling
10.1 Deduplication strategy: If identical `satisfied_if` + `applies_if` appears again, skip or include with separate `source_reference`?  ANSWER: COPY
10.2 Confidence scoring needed? (`confidence_model` 0–1)  ANSWER: YES
10.3 Should ambiguous spans mark fields as `null` or include a `notes` field to flag uncertainty?  ANSWER: ADD UNCERTAINTY SCORE

## 11. Source Referencing
11.1 Do you want page numbers, article numbers, PDF filename? Provide expected fields: `source.doc_id`, `source.page`, `source.article`, `source.span_char_start`, `source.span_char_end`.  YES
11.1b: If inferrable (very likely) also metadata for the document (all the same location tagging, topic tagging)  (WHERE IS IT RELEVANT? WHEN IS IT RELEVANT?)
11.2 If chunked input loses page boundaries, can we accept missing page?  ABNSWER: NO, NEEDS TO BE PRESENT AT ALL TIMES

## 12. Performance & Strategy
12.1 Do you prefer the prompt to instruct the model to process up to a maximum number of Norms per 5k tokens to avoid truncation?  YES, YOU CHOOSE REASONABLE WINDOW. IN ANY CASE, IF TRUNCATION HAPPENS, HAS TO BE ANNOATED, WE NEED TO KNOW.
12.2 Should the prompt instruct incremental streaming (not always possible) or just be stateless per chunk?  YES BEST OPTION

## 13. Language Handling
13.1 Output DSL + keys in English, but keep `Norm` original Spanish text—confirm?  ANSWER: SPANISH
13.2 For questionnaires: Spanish question text or bilingual?  ANSWER: MATCHING SOURCE

## 14. Evolution & Versioning
14.1 Include a `schema_version` top-level field (e.g., `1.0.0`)?   YES
14.2 Include `ontology_version` reference if you maintain separate file?  YES

## 15. Security / Fabrication Guardrails
15.1 Should prompt explicitly forbid hallucinating numerical values not explicitly present? (Probably yes.)  ANSWER: YES, CRITICAL
15.2 Accept partial extraction if JSON would otherwise overflow token limits? Provide `truncated: true` field?  ANSWER: PREFER NO, IF NO OTHER WAY, YES IF ANNOTATED

## 16. Priority Ranking
16.1 Do you need a `priority` for norms (e.g., safety-critical) if keywords like “seguridad”, “emergencia”, “evacuación” appear?  YES

---

## Draft Output Schema (Illustrative – choose / adjust)

Option A (single array):
{
  "schema_version": "1.0.0",
  "ontology_version": "2025-08-21",
  "extractions": [
    {
      "type": "Norm",
      "Norm": "<text span>",
      "Norm_attributes": {
        "paragraph_number": 4,
        "applies_if": "...",
        "satisfied_if": "...",
        "exempt_if": "... or null",
        "obligation_type": "MANDATORY",
        "relevant_tags": ["door.automatic"],
        "relevant_roles": ["architect"],
        "project_types": ["new_build","reform"],
        "lifecycle_phase": "design",
        "location_scope": {
          "country": "ES",
          "autonomous_community": "CAT",
          "province": "B",
          "commune": "Barcelona",
          "planning_zones": ["R6.2"]
        },
        "annex": {
          "requires_annex": true,
          "annex_reference": "Anexo III",
          "annex_type": "fire_safety_form"
        },
        "consequences": ["inspection_required"],
        "source": {
          "doc_id": "ccte_si.pdf",
          "article": "SI 3 6",
            "page": 123,
          "span_char_start": 45012,
          "span_char_end": 45234
        }
      }
    },
    {
      "type": "Tag",
      "tag_path": "door.automatic.fail_safe",
      "tag_attributes": {
        "parent": "door.automatic",
        "definition": "...",
        "synonyms": ["puerta automática fail-safe"],
        "introduced_in_norm_refs": ["SI 3 6.5"],
        "source_doc_ids": ["ccte_si.pdf"]
      }
    },
    {
      "type": "Question",
      "question_id": "Q_DOOR_TYPE",
      "question_attributes": {
        "tag_path": "door.type",
        "question_text": "¿Qué tipo de puerta es?",
        "answer_type": "ENUM",
        "enum_values": ["swing","sliding","folding","tilt_turn","automatic","automatic_pedestrian"],
        "outputs": ["door.type"]
      }
    }
  ]
}

Option B: Separate arrays (simpler for ingestion).

---

## 17. Any Legal/Ethical Constraints
17.1 Need explicit disclaimer field (e.g., “not legal advice”) added to top-level once per document?
